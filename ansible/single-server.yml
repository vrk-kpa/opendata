---

# This playbook installs all roles on a single server

- hosts: all
  become: true

  pre_tasks:
    - name: Ensure www directory exists
      file:
        path: "/var/www"
        state: directory
        mode: "0755"

    - name: Enable maintenance mode
      file:
        path: "/var/www/maintenance"
        state: touch
        mode: "0644"

    - name: Import secrets
      import_role:
        name: secrets
      tags: always

    - name: Install mailhog
      import_role:
        name: mailhog
      when: deployment_environment_id == 'vagrant'
      tags: mailhog

  roles:
    - role: common
      tags: common
    - role: dynatrace
      tags: dynatrace
    - role: postgres
      tags: postgres
    - role: opendata_frontend
      tags: opendata_frontend
    - role: solr
      tags: solr
    - role: redis
      tags: redis
    - role: apache
      tags: apache
    - role: ckan
      tags: ckan
    - role: php
      tags: php
    - role: composer
      tags: composer
    - role: nginx
      tags: nginx
    - role: drupal
      tags: drupal
    - role: datapusher
      tags: datapusher
    - role: dcatap
      tags: dcatap
    - role: prh_tools
      tags: prh_tools

  post_tasks:
    - name: Remove maintenance mode
      file:
        path: "/var/www/maintenance"
        state: absent

    - name: Install cloudwatch agent
      import_role:
        name: cloudwatch_agent
      when: cloudwatch_agent_enabled
      tags: cloudwatch_agent_role
